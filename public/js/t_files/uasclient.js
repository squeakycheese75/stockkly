/*! bbc-pal-uasclient - v0.1.42 - 2017-10-17 */

define("uasclient/polyfills",[],function(){"use strict";"function"!=typeof Object.create&&!function(){var t=function(){};Object.create=function(e){if(arguments.length>1)throw new Error("Second argument not supported");if(null===e)throw new Error("Cannot set a null [[Prototype]]");if("object"!=typeof e)throw new TypeError("Argument must be an object");return t.prototype=e,new t}}(),Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null===t||void 0===t)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(t),a=1;a<arguments.length;a++){var i=arguments[a];if(null!==i&&void 0!==i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])}return r},writable:!0,configurable:!0}),Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=Array.prototype.slice.call(arguments,1),r=this,a=function(){},i=function(){return r.apply(this instanceof a?this:t,e.concat(Array.prototype.slice.call(arguments)))};return this.prototype&&(a.prototype=this.prototype),i.prototype=new a,i})}),define("messages/errorMessages",[],function(){var t={actionContextError:"If an actionContext param is specified there must be an action param",missingOptionsParam:'Required parameter "options" missing or wrong parameter type',configNotPresent:"You must add a configuration object with apiKey, env and domainSuffix",missingRequiredParam:"The following required options are missing : ",callbackNotPresent:"Required callback is missing or is not a function",domainSuffixNotValid:'Invalid domainSuffix, must be either "com" or "co.uk',envNotValid:"Invalid environment, must be either int, test, stage or live",circuitBreakIsActive:"Server error unable to return anything at the moment",timeOut:"The request took too long",uriNotFound:" The required uri was not found",userNotSignedIn:"Error - user not signed in",nonCors500:"Relay could not retrieve a response from the remote server",invalidJson:"Response was not valid JSON",maxBatchSizeExceeded:"Batch create has a maximum of 50 items for each batch",batchEmptyArray:"Batch create requires an array with a length greater than 0",batchNotArray:"Batch create can only accept an array",batchMixedActivityTypes:"There are mixed activityTypes in the array this is not allowed",batchErrorsPrestring:"The following errors or required options are missing : ",metaData:"The metaData is not valid JSON"};return t}),define("uasclient/UasValidator",["messages/errorMessages"],function(t){"use strict";var e=function(){},r=t,a=["apiKey","env","domainSuffix"],i={"int":!0,test:!0,live:!0,stage:!0},n={create:["resourceDomain","resourceType","resourceId","action","actionContext","heartbeat","metaData"],clear:["resourceDomain"],remove:["globalId"],get:["globalId","resourceDomain","resourceType","startIndex","items","action","to","from"]},o={create:{activityType:"required",resourceDomain:"required",resourceType:"required",resourceId:"required",heartbeat:!1,metaData:!1,action:!1,actionContext:!1},clear:{activityType:"required",resourceDomain:!1},remove:{activityType:"required",globalId:"required"},get:{activityType:"required",resourceDomain:!1,resourceType:!1,startIndex:!1,items:!1,action:!1,to:!1,from:!1}};return e.prototype.checkIfConfigIsValid=function(t){if(!t||"[object Object]"!==t.toString())throw this.configValid=!1,new Error(r.configNotPresent);var e,i,n,o=a.length;for(n=0;o>n;n++){if(e=a[n],i=t[e],!t.hasOwnProperty(e)||!i)throw new Error(r.configNotPresent);if("domainSuffix"===e&&!this.validateDomainSuffix(i))throw new Error(r.domainSuffixNotValid);if("env"===e&&!this.validateEnvironment(i))throw new Error(r.envNotValid)}return!0},e.prototype.validateDomainSuffix=function(t){return"com"===t||"co.uk"===t},e.prototype.validateEnvironment=function(t){return i[t]?!0:!1},e.prototype.getCheckAllowedParams=function(t,e,a,i){var s,c,u=n[e],l=o[e],h=u.length,d=!1;for(c=0;h>c;c++)if(s=u[c],t[s]){if("actionContext"===s){if("follows"===a.activityType)continue;t.action||(d=r.actionContextError)}a.data[s]=t[s],"metaData"===s&&this.validateMetaData(t[s],i)}else"required"===l[s]&&i.push(s);return{returnData:a,errors:i,actionContextError:d}},e.prototype.validateMetaData=function(t,e){if("string"==typeof t)try{JSON.parse(t)}catch(a){e.push(r.metaData)}else"[object Object]"!==t.toString()&&e.push(r.metaData)},e.prototype.validateOptions=function(t,e){if("batch"===e)return this.validateBatchPostOptions(t);if("batchGet"===e)return this.validateBatchGetOptions(t);var r,a=[],i={valid:!1,data:{}};return t.activityType&&"required"===o[e].activityType?i.activityType=t.activityType:a.push("activityType"),t.userIsNotSignedIn&&(i.userIsNotSignedIn=t.userIsNotSignedIn),r=this.getCheckAllowedParams(t,e,i,a),this.sortDataForReturn(r.errors,r,i)},e.prototype.validateBatchGetOptions=function(t){for(var e=[],a=!1,i=t.globalIds.length,n=t.activityType,o=0;i>o;++o)"string"!=typeof t.globalIds[o]&&(a=!0,e.push(r.batchErrorsPrestring+" globalIds must be strings"));return a?{valid:!1,data:e}:{valid:!0,data:{globalIds:t.globalIds},activityType:n}},e.prototype.validateBatchPostOptions=function(t){var e,r,a,i,n,o={},s=[],c=t.length,u=t[0].activityType;for(e=0;c>e;e++)r=[],a={valid:!1,data:{}},this.validateMatchingBatchActivityType(t[e],r,u),i=this.getCheckAllowedParams(t[e],"create",a,r),n=this.sortDataForReturn(i.errors,i,a,!0),n.valid?s.push(a.data):n.actionContextError?o[e]=n.actionContextError:o[e]=n.data;return s.length!==t.length?{valid:!1,data:o}:(a={valid:!0,data:s,activityType:u},t.userIsNotSignedIn&&(a.userIsNotSignedIn=t.userIsNotSignedIn),a)},e.prototype.validateMatchingBatchActivityType=function(e,r,a){e.activityType?e.activityType!==a?r.push(t.batchMixedActivityTypes):a=e.activityType:r.push("activityType")},e.prototype.sortDataForReturn=function(t,e,a,i){var n=i?"batchErrorsPrestring":"missingRequiredParam";return t.length?a.data=r[n]+t.join(", "):e.actionContextError!==!1?a.data=e.actionContextError:a.valid=!0,a},e}),define("uasclient/QueryString",[],function(){return{create:function(t){var e,r=[];for(e in t)t.hasOwnProperty(e)&&"undefined"!=typeof t[e]&&r.push(e+"="+encodeURIComponent(t[e]));return r.length?"?"+r.join("&"):""}}}),define("uasclient/CircuitBreaker",[],function(){function t(){r=!1}var e,r=!1,a=5e3;return{trigger:function(){r=!0,window.clearTimeout(e),e=window.setTimeout(t,a)},active:function(){return r},reset:t}}),define("uasclient/CorsRequest",["messages/errorMessages","uasclient/QueryString","uasclient/CircuitBreaker"],function(t,e,r){"use strict";function a(t){for(var e=t.length,r=[],a=0;e>a;a++)r.push(encodeURIComponent(t[a]));return r.join(",")}var i=t,n=function(){},o=n.prototype;return o.init=function(t){this.config=t,this.timeOut=!isNaN(t.timeout)&&parseInt(t.timeout,10)||5e3},o.getUrl=function(t,r){var i,n,o=this.config.env+".";return"live"===this.config.env&&(o=""),n=t.userIsNotSignedIn?"https://nsi.activity.":"https://activity.",n=n+o+"api.bbc."+this.config.domainSuffix+"/my/"+t.activityType,this.config.baseUri&&(n=this.config.baseUri+"/my/"+t.activityType),t.data&&"heartbeat"===t.data.action&&(n="https://heartbeat.activity."+o+"api.bbc."+this.config.domainSuffix+"/my/heartbeat"),"remove"===r&&(i=encodeURIComponent(t.data.globalId),n+="/"+i),"get"===r&&("undefined"!=typeof t.data.globalId&&(i=encodeURIComponent(t.data.globalId),n+="/"+i,delete t.data.globalId),n+=e.create(t.data)),"batch"===r&&(n=t.userIsNotSignedIn?"https://nsi.activity.":"https://activity.",n=n+o+"api.bbc."+this.config.domainSuffix+"/my/batch/"+t.activityType),"batchGet"===r&&(n="https://activity."+o+"api.bbc."+this.config.domainSuffix+"/my/batch/"+t.activityType+"/"+a(t.data.globalIds),delete t.data.globalIds,n+=e.create(t.data)),"clear"===r&&t.data&&t.data.resourceDomain&&(n+=e.create({resourceDomain:t.data.resourceDomain})),n},o.setOptionsForRequest=function(t,e){var r,a,i;return e&&"clear"===e||"remove"===e?r="DELETE":e&&"get"===e||"batchGet"===e?(r="GET",i=JSON.stringify(t.data)):(r="POST",i=JSON.stringify(t.data)),a={url:this.getUrl(t,e),type:r,contentType:"application/json"},i&&(a.data=i),a},o.invalidStatus=function(t){return void 0===t||null===t?!1:!0},o.createRequestObject=function(t,e){var a,n=this;a=new XMLHttpRequest,a.open(t.type,t.url,!0),a.withCredentials="true",a.setRequestHeader("X-API-KEY",this.config.apiKey),a.setRequestHeader("Content-Type",t.contentType),a.setRequestHeader("Accept","application/json");var o="undefined"!=typeof t.data&&"string"==typeof t.data?JSON.parse(t.data):{};return o.heartbeat="undefined"==typeof o.heartbeat||"false"===o.heartbeat?!1:o.heartbeat,o.heartbeat!==!1&&a.setRequestHeader("X-HEARTBEAT",o.heartbeat),delete o.heartbeat,t.data=JSON.stringify(o),a.timeout=this.timeOut,a.ontimeout=function(){e({status:a.status,textStatus:"Timeout",errorFrom:"UAS",responseText:i.timeOut}),r.trigger()},a.onreadystatechange=function(){if(4==a.readyState){var o=a.status,s={};204===o||202===o||200===o?e(null,{status:o,textStatus:a.statusText,responseText:a.responseText}):(s.status=o,s.errorFrom="UAS",o>=500||0===o||n.invalidStatus()?(r.trigger(),s.textStatus=i.circuitBreakIsActive,s.responseText=i.circuitBreakIsActive):404===o?s.responseText=t.url+i.uriNotFound:(s.textStatus=a.statusText,s.responseText=a.responseText),e(s))}},a},o.request=function(t,e,a){if(r.active())return e({status:503,errorFrom:"UAS",textStatus:i.circuitBreakIsActive});var n=this.setOptionsForRequest(t,a),o=this.createRequestObject(n,e);this.makeRequest(o,n)},o.makeRequest=function(t,e){var r=JSON.parse(e.data);if("undefined"!=typeof r.metaData){var a=JSON.parse(r.metaData);r.metaData=a,e.data=JSON.stringify(r)}t.send(e.data)},n}),define("uasclient/RelayRequest",["uasclient/CorsRequest","uasclient/CircuitBreaker","messages/errorMessages","relay-1"],function(t,e,r,a){var i=function(){this.relay=a},n=r;i.prototype=Object.create(t.prototype);var o=i.prototype;return o.setOptionsForRequest=function(t,e){"batch"===e?t.activityType=e+"/"+t.activityType+"/relay":t.activityType=t.activityType+"/relay";var r,a={url:this.getUrl(t)};if(t.data.heartbeat="undefined"!=typeof t.data.heartbeat&&"true"===t.data.heartbeat?"true":t.data.heartbeat,"false"===t.data.heartbeat&&delete t.data.heartbeat,"batch"===e){r=[];for(var i=0,n=t.data.length;n>i;i++)r[i]=t.data[i],r[i].apiKey=this.config.apiKey}else"create"===e&&(r=t.data),"clear"===e&&(r={methodOverride:"DELETE",resourceDomain:t.data.resourceDomain}),"remove"===e&&(r={methodOverride:"DELETE",globalId:t.data.globalId}),r.apiKey=this.config.apiKey;return a.data=JSON.stringify(r),a},o.request=function(t,r,a){if(e.active())return r({status:503,errorFrom:"UAS",textStatus:n.circuitBreakIsActive});var i=this.setOptionsForRequest(t,a);this.makeRequest(i,r)},o.makeRequestCallback=function(t){return function(r){try{var a=JSON.parse(r);if("object"!=typeof a)t({status:502,textStatus:"Bad Gateway",errorFrom:"UAS",responseText:n.invalidJson});else{if("null"==typeof a||"null"==a||null===a)throw new Error(n.nonCors500);t(null,a)}}catch(i){t({status:500,textStatus:"Internal Server Error",errorFrom:"UAS",responseText:i.message}),e.trigger()}}},o.makeRequest=function(t,e){var r=JSON.parse(t.data);if("undefined"!=typeof r.metaData){var a=JSON.parse(r.metaData);r.metaData=a,t.data=JSON.stringify(r)}var i={callback:this.makeRequestCallback(e),timeout:this.config.timeout||1e4};this.relay.post(t.data,t.url,i)},i}),define("uasclient/JsonpRequest",["uasclient/CorsRequest","uasclient/CircuitBreaker","uasclient/QueryString","messages/errorMessages","relay-1"],function(t,e,r,a,i){function n(){}n.counter=0,n.prototype=Object.create(t.prototype);var o=n.prototype;return o.getRequestUrl=function(t,e,r){var a=t.data;return a.api_key=this.config.apiKey,a.callback=e,this.getUrl(t,r)},o.request=function(t,r,i){if(e.active())return r({status:503,errorFrom:"UAS",textStatus:a.circuitBreakIsActive});var o="uasJsonp"+n.counter,s=this.getRequestUrl(t,o,i);this.makeRequest(s,o,r)},o._injectScript=function(t){document.getElementsByTagName("head")[0].appendChild(t)},o.makeRequestCallback=function(t){return function(r){try{if(r instanceof Error)throw r;if("undefined"==typeof r)t(null,{status:204,textStatus:"No Content",responseText:""});else if("object"!=typeof r)t({status:502,textStatus:"Bad Gateway",errorFrom:"UAS",responseText:a.invalidJson});else{if("null"==typeof r||"null"==r||null===r)throw new Error(a.nonCors500);t(null,{status:200,textStatus:"Ok",responseText:JSON.stringify(r)})}}catch(i){t({status:500,textStatus:"Internal Server Error",errorFrom:"UAS",responseText:i.message}),e.trigger()}}},o.makeRequest=function(t,e,r){var a=document.createElement("script"),i=this.makeRequestCallback(r),o=window.setTimeout(function(){window[e]=function(){},i(new Error("Timeout"))},this.config.timeout||5e3);window[e]=function(t){window.clearTimeout(o),window[e]=function(){},i(t)},n.counter++,a.type="text/javascript",a.async=!0,a.src=t,this._injectScript(a)},n}),define("uasclient/TokenRefresh",["idcta/idcta-1"],function(t){var e=function(){this.retryAfter=0,this.maxRetries=3};return e.prototype.getTime=function(){return(new Date).getTime()},e.prototype.setRetryTimeout=function(t,e,r){var a=this.retryAfter-this.getTime();a=Math.max(1,a);var i=this;window.setTimeout(function(){i.refreshToken(t,e,r)},a)},e.prototype.refreshToken=function(e,r,a){if(a||(a=0),a>this.maxRetries)throw new Error("Maximum number of retries for tokenRefresh exceeded");if(this.getTime()>this.retryAfter){var i=this;t.initiateTokenRefresh(!1,null,!0).then(e,function(t){var n={status:t.code?t.code:0,textStatus:"",responseText:t.message?t.message:"ID Unknown Error",errorFrom:"ID"};t.retryAfter&&(n.retryAfter=t.retryAfter,n.triggerRetry=function(){i.retryAfter=t.retryAfter,a++,i.setRetryTimeout(e,r,a)}),r(n)})}else this.setRetryTimeout(e,r,a)},e}),define("uasclient",["uasclient/polyfills","uasclient/UasValidator","uasclient/CorsRequest","messages/errorMessages","uasclient/RelayRequest","uasclient/JsonpRequest","uasclient/TokenRefresh","idcta/idcta-1"],function(t,e,r,a,i,n,o,s){"use strict";var c,u,l=a;"withCredentials"in new XMLHttpRequest?(u=new r,c=new r):(u=new n,c=new i);var h=function(){this.getObj=null,this.postObj=null,this.validator=new e,this.tokenRefresh=new o};return h.prototype.checkOptionsAndCallbackAreValidForBatchPost=function(t,e){if(!t||!Array.isArray(t))throw new Error(l.batchNotArray);var r=t.length;if(r>50)throw new Error(l.maxBatchSizeExceeded);if(!r)throw new Error(l.batchEmptyArray);if(!e||"function"!=typeof e)throw new Error(l.callbackNotPresent)},h.prototype.checkOptionsAndCallbackAreValidForBatchGet=function(t,e){if(!t.globalIds||!Array.isArray(t.globalIds))throw new Error(l.batchNotArray);var r=t.globalIds.length;if(r>25)throw new Error(l.maxBatchSizeExceeded);if(!r)throw new Error(l.batchEmptyArray);if(!e||"function"!=typeof e)throw new Error(l.callbackNotPresent)},h.prototype.checkOptionsAndCallbackAreValid=function(t,e){if(!t||"[object Object]"!==t.toString())throw new Error(l.missingOptionsParam);if(!e||"function"!=typeof e)throw new Error(l.callbackNotPresent)},h.prototype.getOptionsError=function(t,e){var r,a=this.validator.validateOptions(t,e);if(!a.valid)throw r=a.data,"[object Object]"===r.toString()&&(r=JSON.stringify(r,void 0,2)),new Error(r);return a},h.prototype.checkConfigAndSignInStatus=function(t){if(!this.configValid)throw new Error(l.configNotPresent);if(!this.userSignedIn&&!t.allowUserNotSignedIn)throw new Error(l.userNotSignedIn);t.userIsNotSignedIn=!this.userSignedIn},h.prototype.create=function(t,e){try{this.checkOptionsAndCallbackAreValid(t,e),this.checkConfigAndSignInStatus(t);var r=this.getOptionsError(t,"create");r&&this.refreshTokenAndCallRequest(this.postObj,[r,e,"create"],e)}catch(a){throw new Error(a.message)}},h.prototype.remove=function(t,e){try{this.checkOptionsAndCallbackAreValid(t,e),this.checkConfigAndSignInStatus(t);var r=this.getOptionsError(t,"remove");r&&this.refreshTokenAndCallRequest(this.postObj,[r,e,"remove"],e)}catch(a){throw new Error(a.message)}},h.prototype.clear=function(t,e){try{this.checkOptionsAndCallbackAreValid(t,e),this.checkConfigAndSignInStatus(t);var r=this.getOptionsError(t,"clear");r&&this.refreshTokenAndCallRequest(this.postObj,[r,e,"clear"],e)}catch(a){throw new Error(a.message)}},h.prototype.batch=function(t,e){try{this.checkOptionsAndCallbackAreValidForBatchPost(t,e),this.checkConfigAndSignInStatus(t);var r=this.getOptionsError(t,"batch");r&&this.refreshTokenAndCallRequest(this.postObj,[r,e,"batch"],e)}catch(a){throw new Error(a.message)}},h.prototype.batchGet=function(t,e){try{this.checkOptionsAndCallbackAreValidForBatchGet(t,e),this.checkConfigAndSignInStatus(t);var r=this.getOptionsError(t,"batchGet");r&&this.getObj.request(r,e,"batchGet")}catch(a){throw new Error(a.message)}},h.prototype.get=function(t,e){try{this.checkOptionsAndCallbackAreValid(t,e),this.checkConfigAndSignInStatus(t);var r=this.getOptionsError(t,"get");r&&this.refreshTokenAndCallRequest(this.getObj,[r,e,"get"],e)}catch(a){throw new Error(a.message)}},h.prototype.refreshTokenAndCallRequest=function(t,e,r){var a=function(){return t.request.apply(t,e)};this.userSignedIn?this.tokenRefresh.refreshToken(a,r):a()},h.prototype.init=function(t){if(this.configValid=!1,this.userSignedIn=!1,!t)throw new Error(l.configNotPresent);return s.hasCookie()&&(this.userSignedIn=!0),this.validator.checkIfConfigIsValid(t)?(this.config=t,this.configValid=!0,this.postObj=c,this.postObj.init(t),this.getObj=u,this.getObj.init(t),!0):void 0},new h});